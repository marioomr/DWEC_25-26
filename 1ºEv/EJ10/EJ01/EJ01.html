<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Ejercicio 1 - Panel de Soporte Vital</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">Panel Estación Espacial — Soporte Vital & Inventario</h1>

    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">Soporte Vital (última medición)</div>
          <div class="card-body" id="sv-panel">
            <p id="sv-loading">Cargando datos de soporte vital…</p>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card">
          <div class="card-header">Inventario</div>
          <div class="card-body">
            <form id="inv-form" class="row g-2">
              <div class="col-12">
                <label for="item-select" class="form-label">Seleccionar item</label>
                <select id="item-select" class="form-select">
                  <option value="">-- Cargando --</option>
                </select>
              </div>

              <div class="col-6">
                <label class="form-label">Cantidad a usar</label>
                <input id="cantidad-uso" type="number" class="form-control" min="1" value="1">
              </div>

              <div class="col-6 d-flex align-items-end">
                <button id="calc-aut" type="button" class="btn btn-primary w-100">Calcular Autonomía</button>
              </div>

              <div class="col-12 mt-2">
                <p id="disponible"></p>
                <div id="autonomia-result"></div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div id="error-messages" class="mt-3"></div>
  </div>

  <script>
    function cargarXML(url, onSuccess, onError) {
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            onSuccess(xhr.responseXML);
          } else {
            onError(xhr.status, url);
          }
        }
      };
      xhr.send();
    }

    function initSoporteVital() {
      const panel = document.getElementById('sv-panel');

      cargarXML('soporte_vital.xml',
        function(xml) {
          const medicion = xml.querySelector('medicion');
          if (!medicion) {
            panel.innerHTML = '<div class="text-danger">No hay mediciones en el XML.</div>';
            return;
          }
          const ox = medicion.querySelector('oxigeno')?.textContent ?? 'N/A';
          const temp = medicion.querySelector('temperatura')?.textContent ?? 'N/A';
          const pres = medicion.querySelector('presion')?.textContent ?? 'N/A';
          panel.innerHTML = `
            <ul class="list-group">
              <li class="list-group-item">Oxígeno: <strong>${ox}%</strong></li>
              <li class="list-group-item">Temperatura: <strong>${temp} °C</strong></li>
              <li class="list-group-item">Presión: <strong>${pres} hPa</strong></li>
            </ul>
          `;
        },
        function(status, url) {
          panel.innerHTML = `<div class="text-danger">Error cargando ${url} (código ${status}). No se pudieron obtener datos de soporte vital.</div>`;
          document.getElementById('error-messages').innerHTML += `<div class="alert alert-danger">Error ${status}: ${url} no encontrado.</div>`;
        }
      );
    }

    let inventarioXML = null;

    function initInventario() {
      const select = document.getElementById('item-select');
      const disponible = document.getElementById('disponible');
      const btnCalc = document.getElementById('calc-aut');

      cargarXML('inventario.xml',
        function(xml) {
          inventarioXML = xml;
          select.innerHTML = '<option value="">-- Selecciona un item --</option>';
          const items = xml.querySelectorAll('item');
          items.forEach(item => {
            const id = item.getAttribute('id');
            const nombre = item.querySelector('nombre')?.textContent ?? id;
            const option = document.createElement('option');
            option.value = id;
            option.textContent = nombre;
            select.appendChild(option);
          });
        },
        function(status, url) {
          document.getElementById('error-messages').innerHTML += `<div class="alert alert-danger">Error ${status}: ${url} no encontrado. Inventario no disponible.</div>`;
          select.innerHTML = '<option value="">Inventario no disponible</option>';
        }
      );

      select.addEventListener('change', function() {
        const id = this.value;
        if (!inventarioXML || !id) { disponible.textContent = ''; return; }
        const node = inventarioXML.querySelector(`item[id="${id}"]`);
        if (!node) { disponible.textContent = 'Item no encontrado en inventario.'; return; }
        const cantidad = node.querySelector('cantidad')?.textContent ?? '0';
        const unidad = node.getAttribute('unidad') ?? '';
        disponible.textContent = `Disponible: ${cantidad} ${unidad}`;
      });

      btnCalc.addEventListener('click', function() {
        if (!inventarioXML) {
          document.getElementById('autonomia-result').innerHTML = '<div class="text-danger">Inventario no cargado.</div>';
          return;
        }
        const items = Array.from(inventarioXML.querySelectorAll('item'));
        const results = items.map(item => {
          const nombre = item.querySelector('nombre')?.textContent ?? item.getAttribute('id');
          const cantidad = parseFloat(item.querySelector('cantidad')?.textContent ?? '0');
          const consumo = parseFloat(item.querySelector('consumo')?.textContent ?? '0');
          if (isNaN(cantidad) || isNaN(consumo) || consumo <= 0) {
            return `<li class="list-group-item">${nombre}: consumo inválido</li>`;
          }
          const dias = Math.floor(cantidad / (consumo * 4)); 
          return `<li class="list-group-item">${nombre}: <strong>Autonomía ${dias} días</strong> (para 4 personas)</li>`;
        });
        document.getElementById('autonomia-result').innerHTML = `<ul class="list-group mt-2">${results.join('')}</ul>`;
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      initSoporteVital();
      initInventario();
    });
  </script>

</body>
</html>
